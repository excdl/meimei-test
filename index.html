<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>meimei POS ç³»çµ±</title>
<style>
body{margin:0;font-family:"Microsoft JhengHei",Arial,sans-serif;background:#f5f5f5;}
button{cursor:pointer;outline:none;transition:0.2s;}
#posApp{display:flex;height:100vh;}
#posCategories{width:18%;background:#3498db;padding:15px;color:white;overflow-y:auto;border-radius:0 12px 12px 0;}
#posCategories h3{margin-top:0;margin-bottom:10px;font-weight:600;}
#posCategories button{width:100%;margin:5px 0;padding:12px;font-size:0.9em;border:none;border-radius:6px;background:#2980b9;color:white;}
#posCategories button.active{background:#f1c40f;color:#2c3e50;font-weight:bold;}
#posProducts {
    flex: 1;
    padding: 15px 0 15px 5%;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: flex-start;
    align-content: flex-start;
    overflow-y: auto;
}

.product-card {
    background: white;
    border-radius: 12px;
    padding: 10px 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    justify-content: flex-start; /* æ–‡å­—å¤šæ™‚å¾ä¸Šæ–¹é–‹å§‹æ’åˆ— */
    text-align: center;
    transition: 0.3s;
    cursor: pointer;
    width: 120px;
    height: auto; /* é«˜åº¦è‡ªå‹•éš¨æ–‡å­—å¢æ¸› */
    flex-shrink: 0;
    min-height: 60px; /* å¯è¨­å®šæœ€å°é«˜åº¦ï¼Œé¿å…éå° */
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

/* å•†å“åç¨± */
.product-card h4 {
    margin: 0;
    font-size: 0.7em;
    line-height: 1.2em;
    white-space: normal; /* å…è¨±æ›è¡Œ */
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* å•†å“æè¿°/åƒ¹æ ¼ */
.product-card p {
    margin: 3px 0 0 0;
    font-size: 0.75em;
    color: #555;
}

/* è³¼ç‰©è»Šå€ä¿æŒåŸæ¨£ */
#posCartContainer {
    width: 27%;
    background: #f7f7f7;
    padding: 10px;
    display: flex;
    flex-direction: column;
    overflow-y: auto;
    border-left: 2px solid #ddd;
}

.cartHeader {
    font-weight: bold;
    background: #eee;
    font-size: 80%;
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1fr 1fr;
    gap: 5px;
    padding: 5px;
    border-radius: 6px;
    text-align: center;
}

#posCart div.cartRow {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 1fr 1fr;
    gap: 5px;
    background: white;
    padding: 5px;
    margin-bottom: 5px;
    border-radius: 6px;
    align-items: center;
    text-align: center;
    font-size: 0.675em;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#posCart div.cartRow span.name {
    text-align: left;
    cursor: pointer;
    white-space: normal;
    word-break: break-word;
}

#discountContainer{display:flex;gap:5px;margin:5px 0;}
#discountContainer input{flex:1;padding:6px;border:2px solid #ccc;border-radius:6px;text-align:right;font-size:0.9em;cursor:pointer;}
#taxContainer{display:flex;flex-wrap:wrap;gap:5px;margin:5px 0;}
#taxContainer button{flex:1 1 30%;padding:6px;border:none;border-radius:6px;background:#bdc3c7;cursor:pointer;}
#taxContainer button.active{background:#f1c40f;color:#333;font-weight:bold;}
#cashPanel{display:block;margin-top:5px;}
#cashPanel input{width:100%;padding:8px;margin-top:5px;border:2px solid #ccc;border-radius:6px;text-align:right;font-size:1em;cursor:pointer;}
#posCheckout{margin-top:8px;padding:12px;font-size:1.2em;background:#27ae60;color:white;border:none;border-radius:6px;}
#editModal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:9999;}
#editModal .modalContent{background:white;padding:20px;border-radius:12px;width:90%;max-width:350px;text-align:center;}

#numpad{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:5px;}
#numpad button{padding:15px;background:#3498db;color:white;font-size:1.2em;border:none;border-radius:6px;}
#promoButtons{display:grid;grid-template-columns:repeat(2,1fr);gap:6px;margin-top:10px;}
#promoButtons button{padding:8px;background:#3498db;color:white;font-size:0.9em;border:none;border-radius:6px;}
.modalActions{display:flex;gap:5px;margin-top:10px;}
.modalActions button{flex:1;padding:10px;border:none;border-radius:6px;}
.confirm{background:#27ae60;color:white;}
.cancel{background:#e74c3c;color:white;}
.convert{background:#f39c12;color:white;}
@media (max-width:600px){
  #numpad button{padding:20px;font-size:1.5em;}
  #editModal input{font-size:1.8em;}
}
#editModal.promoMode #modalInput {display: none !important; margin: 0 !important; padding: 0 !important; height: 0 !important;}  
#printArea{display:none;width:58mm;font-size:12px;line-height:1.2em;}
#printArea h4{text-align:center;margin:2px 0;}
#printArea table{width:100%;border-collapse:collapse;}
#printArea td{text-align:left;}
#printArea td.right{text-align:right;}
#taxSummary {
    margin-top: 8px;
    padding: 12px 14px;
    background: #f9f9f9;
    border-radius: 8px;
    border-left: 5px solid #f1c40f;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    font-size: 0.95em;
}

/* æ¯åˆ—æ’ç‰ˆ */
#taxSummary .taxRow {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 6px 0;
    white-space: nowrap;
}

/* å·¦é‚Šæ¨™ç±¤å›ºå®šå¯¬åº¦ï¼Œæ•´é«”æ›´æ•´é½Š */
#taxSummary .label {
    width: 90px; /* â˜… å·¦æ¬„å›ºå®šå¯¬åº¦ï¼Œé¿å…æ™ƒå‹• */
    color: #2c3e50;
}

/* å³é‚Šé‡‘é¡ä½¿ç”¨ç­‰å¯¬å­—å‹ï¼Œæ°¸é é å³å°é½Š */
#taxSummary .value {
    min-width: 110px; /* â˜… å³å´æ•¸å­—å›ºå®šå¯¬åº¦ */
    text-align: right;
    font-family: 'Courier New', monospace; /* â˜… ç­‰å¯¬å­—é«” */
    font-size: 1.05em;
    font-weight: 600;
    color: #2c3e50;
}

/* ç¨…å¾Œç¸½é¡çªå‡ºé¡¯ç¤º */
#taxSummary .total .value {
    color: #c0392b;
    font-weight: bold;
    font-size: 1.15em;
}

#todaySalesDisplay {
    margin-top: 10px;
    padding: 12px 15px;
    border-radius: 10px;
    background: #ecf0f1;
    border-left: 6px solid #2980b9;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);

    font-size: 14px;
    line-height: 1.6em;
    color: #2c3e50;
    white-space: pre-line;
}

#todaySalesDisplay b {
    font-size: 15px;
    color: #2980b9;
}
#paymentButtons {
    display: flex;
    gap: 10px;
    margin: 12px 0; /* èˆ‡ä¸‹é¢ä¿æŒä¸€è‡´ */
}

#paymentButtons .payBtn {
    height: 42px; /* åŸ 60px Ã— 0.7 = 42px */
    border-radius: 6px; /* èˆ‡ taxContainer æŒ‰éˆ•ä¸€è‡´ */
    background-color: #bdc3c7; /* åˆå§‹ç°è‰² */
    color: #333; /* æ·±è‰²æ–‡å­— */
    border: none;
    flex: 1;            /* å¹³åˆ†å¯¬åº¦ */
    cursor: pointer;
    font-size: 0.9em;
    font-weight: normal;
    transition: 0.2s;
}

#paymentButtons .payBtn:hover {
    background-color: #95a5a6; /* hover ç¨å¾®æ·±ä¸€é»ç° */
}

#paymentButtons .payBtn.active {
    background-color: #f1c40f; /* é»é¸å¾Œè®Šé»ƒ */
    color: #333;               /* æ–‡å­—æ·±è‰² */
    font-weight: bold;          /* åŠ ç²— */
}

  #discountContainer, .taxRow.total, #paymentButtons {
    margin: 12px 0; /* ä¸Šä¸‹ 12px */
}
#logoutBtn.active {
    background-color: #ccc;  /* é‹ä½œä¸­æç¤ºè‰²ï¼Œå¯è‡ªè¡Œèª¿æ•´ */
}
/* ======= æ–°çš„æŠ˜æ‰£/ç¾é‡‘éµç›¤ï¼šè¶…å•† POS é¢¨æ ¼ ======= */
#posKeypadModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

.keypadBox {
  background: #2b2b2b;
  padding: 18px;
  width: 340px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 0 30px rgba(0,0,0,0.35);
  position: relative; /* è®“å³ä¸Š X çµ•å°å®šä½åœ¨ modal å…§ */
}

#posKeypadTitle {
  margin-bottom: 10px;
  font-size: 22px;
  font-weight: bold;
  color: #fff;
}

#posKeypadInput {
  width: 100%;
  font-size: 32px;
  padding: 12px;
  margin-bottom: 15px;
  text-align: right;
  border: none;
  border-radius: 8px;
  box-sizing: border-box;
  background: #111;
  color: #0f0;
  letter-spacing: 2px;
}

.posKeypadGrid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.posKeypadGrid button {
  height: 60px;
  font-size: 20px;
  border: none;
  border-radius: 8px;
  background: #444;
  color: #fff;
  box-shadow: inset 0 -3px 0 rgba(0,0,0,0.35);
}

.posKeypadGrid button:active {
  transform: translateY(2px);
  box-shadow: none;
}

.posKeypadGrid button.big {
  background: #0277bd;  /* è—è‰²é‡‘é¡éµ */
  font-weight: bold;
}

.posKeypadGrid button.confirm {
  background: #43a047;  /* ç¶ è‰²ç¢ºèªéµ */
  font-size: 22px;
  font-weight: bold;
}

/* ======= æ–°çš„æŠ˜æ‰£/ç¾é‡‘éµç›¤ï¼šè¶…å•† POS é¢¨æ ¼ ======= */
#posKeypadModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 99999;
}

.keypadBox {
  background: #2b2b2b;
  padding: 18px;
  width: 340px;
  border-radius: 14px;
  text-align: center;
  box-shadow: 0 0 30px rgba(0,0,0,0.35);
  position: relative; /* X çš„å®šä½ */
}

/* â­ å¤§éµç›¤å³ä¸Šè§’ X */
#posCloseBtn {
  display: block !important;  /* æ°¸é é¡¯ç¤º */
}

/* ======== å³ä¸Šè§’ X æŒ‰éˆ• ======== */
.closeModal {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 28px;
  height: 28px;
  line-height: 28px;
  text-align: center;
  border-radius: 50%;
  background: #ccc;
  cursor: pointer;
  font-weight: bold;
  font-size: 18px;
  transition: background 0.2s;
  z-index: 10;
}

.closeModal:hover {
  background: #999;
  color: white;
}

#posKeypadTitle {
  margin-bottom: 10px;
  font-size: 22px;
  font-weight: bold;
  color: #fff;
}

#posKeypadInput {
  width: 100%;
  font-size: 32px;
  padding: 12px;
  margin-bottom: 15px;
  text-align: right;
  border: none;
  border-radius: 8px;
  box-sizing: border-box;
  background: #111;
  color: #0f0;
  letter-spacing: 2px;
}

.posKeypadGrid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 10px;
}

.posKeypadGrid button {
  height: 60px;
  font-size: 20px;
  border: none;
  border-radius: 8px;
  background: #444;
  color: #fff;
  box-shadow: inset 0 -3px 0 rgba(0,0,0,0.35);
}

.posKeypadGrid button:active {
  transform: translateY(2px);
  box-shadow: none;
}

.posKeypadGrid button.big {
  background: #0277bd;
  font-weight: bold;
}

.posKeypadGrid button.confirm {
  background: #43a047;
  font-size: 22px;
  font-weight: bold;
}

/* ======== å…±ç”¨å°éµç›¤ modal ======== */
#editModal {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.45);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#editModal .modalContent {
  background: #2b2b2b;
  padding: 20px;
  width: 340px;
  border-radius: 14px;
  box-shadow: 0 0 25px rgba(0,0,0,0.35);
  text-align: center;
  position: relative;
}

#modalInput {
  width: 80%;
  margin: 0 auto 15px auto;
  display: block;
  font-size: 30px;
  padding: 12px;
  border-radius: 8px;
  text-align: center;
  border: none;
  background: #111;
  color: #0f0;
  letter-spacing: 2px;
  box-sizing: border-box;
}

#numpad {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
}

#numpad button {
  height: 60px;
  font-size: 22px;
  background: #444;
  color: white;
  border: none;
  border-radius: 8px;
}

.modalActions {
  margin-top: 15px;
  display: flex;
  justify-content: space-between;
}

.modalActions .cancel,
.modalActions .confirm {
  flex: 1;
  height: 50px;
  font-size: 20px;
  border: none;
  border-radius: 8px;
  margin: 0 5px;
  font-weight: bold;
  color: #fff;
}

.modalActions .cancel { background: #d32f2f; }
.modalActions .confirm { background: #43a047; }

/* åˆå§‹ç™»å‡ºæŒ‰éˆ• */
#logoutBtn {
    color: white;
    background-color: #d35400;
    transition: background-color 0.3s, color 0.3s;
}

/* ç™»å‡ºä¸­æ•ˆæœ */
#logoutBtn.active {
    animation: btnPulse 1s infinite;
    color: #ffffff; /* æ–‡å­—ç™½è‰² */
    position: relative;
}

/* æ¼¸è®Šé–ƒçˆå‹•ç•« */
@keyframes btnPulse {
    0%   { background-color: #e67e22; color: #ffffff; }
    50%  { background-color: #f39c12; color: #ffffff; }
    100% { background-color: #e67e22; color: #ffffff; }
}

/* é–ƒçˆå°é» */
#logoutBtn.active::after {
    content: 'â€¢';
    animation: blink 1s infinite;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: white;
}

@keyframes blink {
    0%, 50%, 100% { opacity: 0; }
    25%, 75% { opacity: 1; }
}
#posCheckout.minAlert {
  background:#f39c12 !important;
}
.search-container {
    display: flex;
    flex-wrap: wrap; /* å°è¢å¹•è‡ªå‹•æ›è¡Œ */
    gap: 5px;
    margin-bottom: 10px;
    align-items: center;
  }

  .search-container button {
    width: 120px;               /* å›ºå®šå¯¬åº¦ */
    height: 40px;               /* å›ºå®šé«˜åº¦ */
    font-size: 14px;
    background-color: #8e44ad;  /* ä¿®æ”¹æŒ‰éˆ•èƒŒæ™¯è‰²ï¼Œä¸åŒæ–¼åº•è‰² */
    border: none;
    cursor: pointer;
    color: white;
    display: flex;              /* è®“æ–‡å­—èˆ‡åœ–ç¤ºç½®ä¸­ */
    align-items: center;        /* å‚ç›´ç½®ä¸­ */
    justify-content: center;    /* æ°´å¹³ç½®ä¸­ */
    gap: 5px;                   /* æ–‡å­—å’Œåœ–ç¤ºé–“è· */
    border-radius: 5px;         /* åœ“è§’æŒ‰éˆ• */
  }

  .search-container input {
    flex: 1;                     /* æ’æ»¿å‰©é¤˜ç©ºé–“ */
    min-width: 120px;            /* æœ€å°å¯¬åº¦ */
    height: 40px;
    padding: 0 10px;
    font-size: 14px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }

  /* å°è¢å¹•èª¿æ•´ */
  @media (max-width: 480px) {
    .search-container button, .search-container input {
      flex: 1;                  /* å„ä½”ä¸€è¡Œ */
    }
  }
  
</style>
</head>

  
<body>

<!-- ç™»å…¥é é¢ -->
<div id="loginPage" style="display:flex;justify-content:center;align-items:center;height:100vh;background:#3498db;">
  <div style="background:white;padding:40px 30px;border-radius:12px;box-shadow:0 5px 20px rgba(0,0,0,0.2);width:320px;text-align:center;">
    <h2>
  <span class="line1">MeiMeiã®åº—</span>
  <span class="line2">ç™»å…¥</span>
</h2>
    <input id="storeInput" placeholder="é–€å¸‚ç·¨è™Ÿ" style="width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #ccc;font-size:1em;">
    <input id="passwordInput" placeholder="å¯†ç¢¼" type="password" style="width:100%;padding:10px;margin:10px 0;border-radius:6px;border:1px solid #ccc;font-size:1em;">
    <button id="loginBtn" style="width:100%;padding:12px;margin-top:15px;border:none;border-radius:6px;background:#27ae60;color:white;font-size:1em;cursor:pointer;transition:0.2s;">ç™»å…¥</button>
    <p id="loginMsg" style="color:red;margin-top:10px;font-size:0.9em;"></p>
  </div>
</div>

<!-- POS ä¸»é  -->
<div id="posApp" style="display:none;">
  <div id="posCategories">
    <div id="storeInfo" style="font-size:14px; font-weight:bold; margin-bottom:10px;"></div>
    <div id="loginTime" style="font-size:12px; color: white; margin-bottom: 10px;"></div>
    <button id="logoutBtn" style="margin-bottom:10px; font-size:13px; background-color:#d35400; border:none; padding:5px 10px; cursor:pointer; color:white;">
      ç™»å‡º
    </button>

    <!-- æŸ¥è©¢å­˜é…’æŒ‰éˆ• + æœå°‹æ¡†ï¼ŒéŸ¿æ‡‰å¼ -->
<div class="search-container">
  <button id="checkWineBtn">
    ğŸ¾ æŸ¥è©¢å­˜é…’
  </button>
  <input type="text" id="searchBox" placeholder="æœå°‹å•†å“">
</div>
      
    <h3>åˆ†é¡</h3>
  </div>
  <div id="posProducts"></div>
  <div id="posCartContainer">
    <h3 style="font-size:85%;">è¨‚å–®æ˜ç´°</h3>
    <div class="cartHeader">
      <span>å•†å“</span><span>æ•¸é‡</span><span>å–®åƒ¹</span><span>å°è¨ˆ</span><span>åˆªé™¤</span>
    </div>
    <div id="posCart"></div>
  
 <!-- ===== äººæ•¸ / ä½æ¶ˆ / æ¥­ä»£ åŒè¡Œ ===== -->
<div id="tableInfo" style="margin:8px 0; font-size:13.2px; display:flex; align-items:center; gap:10px; flex-wrap:nowrap;">

  <label style="white-space:nowrap;">
    äººæ•¸ï¼š
    <input id="peopleCount" type="number" min="1" value="1"
           style="width:55px; font-size:13.2px; padding:2px 4px;">
  </label>

  <label style="white-space:nowrap;">
    ä½æ¶ˆï¼š
    <input id="minConsumeInput" type="number" min="0" value="400"
           style="width:77px; font-size:13.2px; text-align:right; padding:2px 4px;">
    å…ƒ/äºº
  </label>

  <label style="white-space:nowrap;">
    æ¥­ä»£ï¼š
    <input id="salesInput"
           list="salesList"
           placeholder="è«‹é¸æ“‡æ¥­ä»£"
           style="width:132px; font-size:13.2px; padding:2px 4px;">
    <datalist id="salesList"></datalist>
  </label>

</div>
 
  <div id="taxContainer">
  <button id="taxIncluded" class="active" onclick="setTax('æ‡‰ç¨…')">æ‡‰ç¨…</button>
  <button id="taxExempt" onclick="setTax('å…ç¨…')">å…ç¨…</button>
</div>

<div id="taxSummary">
  <div class="taxRow">
    <span class="label">ç¨…å‰é‡‘é¡ï¼š</span>
    <span class="value"><span id="beforeTax">0</span> å…ƒ</span>
  </div>
  <div class="taxRow">
    <span class="label">ç¨…é¡ï¼š</span>
    <span class="value"><span id="taxAmount">0</span> å…ƒ</span>
  </div>
  <div class="taxRow total">
    <span class="label">ç¨…å¾Œç¸½é¡ï¼š</span>
    <span class="value"><span id="afterTax">0</span> å…ƒ</span>
  </div>
</div>
<div id="discountContainer">
      <input type="text" id="discount" placeholder="æŠ˜æ‰£é‡‘é¡" readonly>
    </div>
   <div class="taxRow total">
  <span class="label">æ‡‰æ”¶ç¸½é¡ï¼š</span>
  <span class="value"><span id="posTotal">0</span> å…ƒ</span>
</div>
<div id="minConsumeAlert"
     style="display:none;color:#c0392b;font-weight:bold;font-size:13px;">
âš  æœªé”ä½æ¶ˆï¼Œå·²ä»¥ä½æ¶ˆè¨ˆç®—
</div>

   <div id="paymentButtons">
  <button class="payBtn" data-pay="ç¾é‡‘">ç¾é‡‘</button>
  <button class="payBtn" data-pay="åˆ·å¡">åˆ·å¡</button>
  <button class="payBtn" data-pay="Line Pay">Line Pay</button>
</div>

<div id="cashPanel" style="display:none; margin-top:10px;">
  æ”¶ç¾é‡‘ï¼š<input type="number" id="cashInput" value="0" placeholder="æ”¶ç¾é‡‘é¡">
  æ‰¾é›¶ï¼š<span id="changeOut">0</span> å…ƒ
</div>

<input type="hidden" id="posPayment" value="">
<input id="customerName" placeholder="å®¢æˆ¶å§“åï¼ˆå­˜é…’å¿…å¡«ï¼‰">
<input id="customerPhone" placeholder="æ‰‹æ©Ÿï¼ˆå­˜é…’å¿…å¡«ï¼‰">

  <!-- çµå¸³æŒ‰éˆ• -->
<button id="posCheckout">çµå¸³åˆ—å°</button>

<div id="shiftDailyContainer" style="display:flex; gap:10px; margin:20px 0;">
  <button id="shiftEndBtn" style="flex:1; background:#c0392b; color:white; border:none; border-radius:6px; padding:10px;">äº¤ç­çµç®—</button>
  <button id="dailySalesBtn" style="flex:1; background:#2980b9; color:white; border:none; border-radius:6px; padding:10px;">ç•¶æ—¥ç‡Ÿæ¥­é¡</button>
</div>

<div id="todaySalesDisplay" style="margin-top:10px; white-space:pre-line;"></div>

<!-- ======== å°éµç›¤ / å„ªæƒ æ–¹æ¡ˆå…±ç”¨ Modal ======== -->
<div id="editModal">
  <div class="modalContent">
    <span class="closeModal" id="editCloseBtn" onclick="closeModal()">Ã—</span>
    <h4 id="modalProductName" style="color:#fff;">è¼¸å…¥</h4>
    <input id="modalInput">

    <!-- å°éµç›¤ -->
    <div id="numpad">
      <button onclick="np('7')">7</button><button onclick="np('8')">8</button><button onclick="np('9')">9</button>
      <button onclick="np('4')">4</button><button onclick="np('5')">5</button><button onclick="np('6')">6</button>
      <button onclick="np('1')">1</button><button onclick="np('2')">2</button><button onclick="np('3')">3</button>
      <button onclick="np('0')">0</button><button onclick="np('.')">.</button><button onclick="backspace()">â†</button>
    </div>

    <!-- å„ªæƒ æ–¹æ¡ˆæŒ‰éˆ• -->
    <div id="promoButtons"></div>

    <!-- å°éµç›¤ç¢ºèª/å–æ¶ˆæŒ‰éˆ• -->
    <div class="modalActions">
      <button class="cancel" onclick="closeModal()">å–æ¶ˆ</button>
      <button class="confirm" onclick="confirmEdit()">ç¢ºå®š</button>
    </div>
  </div>
</div>

<!-- ======= POS å¤§éµç›¤ï¼ˆæŠ˜æ‰£ / æ”¶ç¾é‡‘ å°ˆç”¨ï¼‰ ======= -->
<div id="posKeypadModal">
  <div class="keypadBox">
    <span class="closeModal" id="posCloseBtn" onclick="closeModal()">Ã—</span>
    <h3 id="posKeypadTitle">è¼¸å…¥</h3>
    <input id="posKeypadInput" readonly>
    <div class="posKeypadGrid">
      <button class="big" onclick="kpInput('1000')">1000</button>
      <button onclick="kpInput('7')">7</button>
      <button onclick="kpInput('8')">8</button>
      <button onclick="kpInput('9')">9</button>

      <button class="big" onclick="kpInput('500')">500</button>
      <button onclick="kpInput('4')">4</button>
      <button onclick="kpInput('5')">5</button>
      <button onclick="kpInput('6')">6</button>

      <button class="big" onclick="kpInput('100')">100</button>
      <button onclick="kpInput('1')">1</button>
      <button onclick="kpInput('2')">2</button>
      <button onclick="kpInput('3')">3</button>

      <button class="confirm" onclick="kpConfirm()">ç¢ºèª</button>
      <button onclick="kpInput('00')">00</button>
      <button onclick="kpInput('0')">0</button>
      <button onclick="kpBack()">â†</button>
    </div>
  </div>
</div>
<!-- ===== ä½æ¶ˆè£œå·®ç¢ºèªè¦–çª— ===== -->
<div id="minConsumeConfirm"
style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
background:rgba(0,0,0,0.45);z-index:100000;
justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:12px;width:90%;max-width:360px;text-align:center;">
    <h3 style="color:#e67e22;margin-top:0;">âš  ä½æ¶ˆè£œå·®ç¢ºèª</h3>
    <p id="minConsumeConfirmText"></p>
    <div style="display:flex;gap:10px;">
      <button onclick="cancelMinConsumeCheckout()" style="flex:1;">å–æ¶ˆ</button>
      <button onclick="confirmMinConsumeCheckout()" style="flex:1;background:#e67e22;color:white;">ç¢ºèªçµå¸³</button>
    </div>
  </div>
</div>
<!-- ===== å­˜é…’é¸æ“‡ Modal ===== -->
<div id="storeWineModal"
     style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;
     background:rgba(0,0,0,0.45);z-index:100000;
     justify-content:center;align-items:center;">
  <div style="background:white;padding:20px;border-radius:12px;width:90%;max-width:320px;text-align:center;">
    <h3 id="storeWineTitle"></h3>
    <p>æ˜¯å¦è¦å°‡æ­¤å•†å“è¨­ç‚ºå­˜é…’ï¼Ÿ</p>
    <div style="display:flex;gap:10px;">
      <button onclick="confirmStoreWine(false)" style="flex:1;">ç›´æ¥è²©å”®</button>
      <button onclick="confirmStoreWine(true)" style="flex:1;background:#27ae60;color:white;">å­˜é…’</button>
    </div>
  </div>
</div>

    
<!-- åˆ—å°æ”¶æ“šå€ -->
<div id="printArea"></div>

</body>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxIONfqq50nNi5V0XKYaWN1k4-1pBhUChyOLsFOkCYGUr55y6FfG_Vb5f3Jrl7l9xk0Kg/exec";
function formatNumber(num) { if (num === null || num === undefined || num === "") return "0"; let n = Number(num); if (isNaN(n)) return "0"; return n.toLocaleString('zh-TW'); }
let POS_STORE = "";
let posCart = [], currentTax = "æ‡‰ç¨…";
let editIndex = null;       // æ­£åœ¨ç·¨è¼¯çš„å•†å“ç´¢å¼•
let editingField = null;    // æ­£åœ¨ç·¨è¼¯çš„æ¬„ä½
let modalType = null;
let kpTarget = null;


  // ====== æ›´å¿«çš„ IP å–å¾—ï¼ˆå« sessionStorage å¿«å–ï¼‰======
async function getIP() {
    const cache = sessionStorage.getItem("myIP");
    if (cache) return cache;

    try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        sessionStorage.setItem("myIP", data.ip);
        return data.ip;
    } catch {
        return "";
    }
}

function updateLoginTime() {
  const now = new Date();
  document.getElementById("loginTime").innerText = `ç™»å…¥æ™‚é–“ï¼š${now.toLocaleString("zh-TW",{hour12:false})}`;
}

async function login() {
  const loginBtn = document.getElementById("loginBtn");
  loginBtn.innerText = "ç™»å…¥ä¸­...";
  loginBtn.disabled = true;

  const store = document.getElementById("storeInput").value;
  const pwd = document.getElementById("passwordInput").value;
  const userIP = await getIP();

  try {
    const res = await fetch(`${API_URL}?action=login&store=${store}&pwd=${pwd}&ip=${userIP}`);
    const data = await res.json();

    if (data.status === "success") {
      POS_STORE = data.storeCode;

      // éš±è—ç™»å…¥é ï¼Œé¡¯ç¤º POS
      document.getElementById("loginPage").style.display = "none";
      document.getElementById("posApp").style.display = "flex";

      // é¡¯ç¤ºé–€å¸‚è³‡è¨Š
      document.getElementById("storeInfo").innerText = `${data.storeName}ï¼ˆ${data.storeCode}ï¼‰`;

      // æ›´æ–°ä¸¦æ¯ç§’åˆ·æ–°ç™»å…¥æ™‚é–“
      updateLoginTime();
      setInterval(updateLoginTime, 1000);
      
      // å–å¾—å•†å“è³‡æ–™
      fetchProducts();
      fetchSalesList();
      setTimeout(() => {
    const cashBtn = document.querySelector('#paymentButtons .payBtn[data-pay="ç¾é‡‘"]');
    if (cashBtn) cashBtn.click();
}, 0);

    } else {
      document.getElementById("loginMsg").innerText = data.message;
      loginBtn.innerText = "ç™»å…¥";
      loginBtn.disabled = false;
    }
  } catch (err) {
    console.error(err);
    document.getElementById("loginMsg").innerText = "ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦";
    loginBtn.innerText = "ç™»å…¥";
    loginBtn.disabled = false;
  }
}

// ===== æ›´æ–°ç™»å…¥æ™‚é–“ =====
function updateLoginTime() {
  const now = new Date();
  const timeStr = now.toLocaleString("zh-TW", { hour12: false });
  document.getElementById("loginTime").innerText = `ç™»å…¥æ™‚é–“ï¼š${timeStr}`;
}

document.getElementById("logoutBtn").onclick = logout;

async function logout() {
    const logoutBtn = document.getElementById("logoutBtn");

    // é»æ“Šå¾Œæ‰æ”¹æ–‡å­—
    logoutBtn.disabled = true;
    logoutBtn.innerText = "ç™»å‡ºä¸­...";
    logoutBtn.classList.add("active");

    const now = new Date();
    const logoutTime = now.toLocaleString("zh-TW", { hour12: false });

    try {
        await fetch(`${API_URL}?action=logout&store=${POS_STORE}&time=${encodeURIComponent(logoutTime)}`);
    } catch (err) {
        console.error(err);
    } finally {
        // éš±è— POS ä¸»é ï¼Œé¡¯ç¤ºç™»å…¥é 
        document.getElementById("posApp").style.display = "none";
        document.getElementById("loginPage").style.display = "flex";

        // æ¸…ç©ºç™»å…¥æ¬„ä½
        document.getElementById("storeInput").value = "";
        document.getElementById("passwordInput").value = "";
        document.getElementById("loginMsg").innerText = "";

        // é‡ç½®ç™»å…¥æŒ‰éˆ•
        const loginBtn = document.getElementById("loginBtn");
        loginBtn.innerText = "ç™»å…¥";
        loginBtn.disabled = false;

        // æ¸…é™¤ POS_STORE
        POS_STORE = "";

        // æ¢å¾©ç™»å‡ºæŒ‰éˆ•ç‹€æ…‹
        logoutBtn.disabled = false;
        logoutBtn.innerText = "ç™»å‡º"; // å›ºå®šå›ã€Œç™»å‡ºã€
        logoutBtn.classList.remove("active");
    }
}

// ç¶å®šæŒ‰éˆ•äº‹ä»¶
document.getElementById("loginBtn").addEventListener("click", login);
document.getElementById("logoutBtn").addEventListener("click", logout);


// ===== å–å¾—å•†å“ =====
async function fetchProducts() {
    const res = await fetch(API_URL + "?action=products");
    products = await res.json();
    categories = [...new Set(products.map(x => x["é¡åˆ¥"]))];
    renderCategories();
    if (categories.length > 0) renderProducts(categories[0]);
}

async function fetchSalesList() {
  try {
    const res = await fetch(`${API_URL}?action=salesList&storeCode=${POS_STORE}`);
    const data = await res.json();

    if (data.status !== "success") return;

    const listEl = document.getElementById("salesList");
    listEl.innerHTML = "";

    data.list.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      listEl.appendChild(opt);
    });

    // â­ é è¨­å¸¶å…¥ç™»å…¥è€…
    // â­ æ”¹ç‚ºé è¨­ç©ºç™½
document.getElementById("salesInput").value = "";
  } catch (err) {
    console.error("è¼‰å…¥æ¥­ä»£å¤±æ•—", err);
  }
}    
// ===== æ¸²æŸ“åˆ†é¡ =====
function renderCategories() {
    const box = document.getElementById("posCategories");
    box.querySelectorAll("button.cat-btn").forEach(b => b.remove());

    categories.forEach(cat => {
        const btn = document.createElement("button");
        btn.classList.add("cat-btn");
        btn.textContent = cat;
        btn.onclick = () => {
            document.querySelectorAll("#posCategories button.cat-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            renderProducts(cat);
        };
        box.appendChild(btn);
    });

    const firstBtn = box.querySelector("button.cat-btn");
    if (firstBtn) firstBtn.classList.add("active");
}

// ===== æœå°‹å•†å“ =====
document.getElementById("searchBox").oninput = function () {
    renderProducts(null, this.value.trim().toLowerCase());
};

  function parseNumber(str) {
    return Number(str.replace(/,/g, ""));
}

/*********************************
 * å­˜é…’ Modal æ§åˆ¶ç”¨
 *********************************/
let pendingStoreProduct = null;

/*********************************
 * ===== æ¸²æŸ“å•†å“ï¼ˆå”¯ä¸€ç‰ˆæœ¬ï¼‰=====
 *********************************/
function renderProducts(category = null, search = "") {
    const box = document.getElementById("posProducts");
    box.innerHTML = "";

    products
        .filter(p => {
            if (category && p["é¡åˆ¥"] !== category) return false;
            if (search && !p["å•†å“åç¨±"].toLowerCase().includes(search.toLowerCase())) return false;
            return true;
        })
        .forEach(p => {
            console.log(
  "DEBUG å•†å“ï¼š",
  p["å•†å“åç¨±"],
  "| æ˜¯å¦å­˜é…’ =",
  JSON.stringify(p["æ˜¯å¦å­˜é…’"]),
  "| å…¨ç‰©ä»¶ =",
  p
);
          
            const card = document.createElement("div");
            card.className = "product-card";
            card.innerHTML = `
                <h4>${p["å•†å“åç¨±"]}</h4>
                <p>${p["å”®åƒ¹"]} å…ƒ / ${p["å–®ä½"]}</p>
            `;

            card.onclick = () => {
                if (p["æ˜¯å¦å­˜é…’"] === "Y") {
                    openStoreWineModal(p);
                } else {
                    addPOSItem(p, false);
                }
            };

            box.appendChild(card);
        });
}

/*********************************
 * ===== å­˜é…’ Modal =====
 *********************************/
function openStoreWineModal(product) {
    pendingStoreProduct = product;
    document.getElementById("storeWineTitle").innerText =
        `ã€${product["å•†å“åç¨±"]}ã€‘`;
    document.getElementById("storeWineModal").style.display = "flex";
}

function confirmStoreWine(isStore) {
    if (!pendingStoreProduct) return;
    addPOSItem(pendingStoreProduct, isStore);
    pendingStoreProduct = null;
    document.getElementById("storeWineModal").style.display = "none";
}

/*********************************
 * ===== åŠ å…¥è³¼ç‰©è»Šï¼ˆæ”¯æ´å­˜é…’ï¼‰=====
 *********************************/
function addPOSItem(p, forceStore = false) { 
    let qtyAdd = 1;
    let pricePerUnit = Number(p["å”®åƒ¹"]);
    let unit = p["å–®ä½"];
    if (unit === "åŠæ–¤") { 
        qtyAdd = 0.5; 
        pricePerUnit *= 2; 
        unit = "æ–¤"; 
    }

    // è¨ˆç®—å­˜é…’æ—¥æœŸ
    const now = new Date();
    let expireDate = null;
    if (forceStore) {
        const months = p["å­˜é…’æœŸé™(æœˆ)"] ? Number(p["å­˜é…’æœŸé™(æœˆ)"]) : 2;
        const d = new Date(now);
        d.setMonth(d.getMonth() + months);
        expireDate = d.toLocaleDateString("zh-TW");
    }

    // æŸ¥è©¢è³¼ç‰©è»Šå…§æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå•†å“ï¼ˆåŒå­˜é…’ç‹€æ…‹ï¼‰
    let exist = posCart.find(x => x.name === p["å•†å“åç¨±"] && x.isStored === forceStore);

    if (exist) {
        exist.quantity += qtyAdd;
    } else {
        posCart.push({
            name: p["å•†å“åç¨±"],
            quantity: qtyAdd,
            price: pricePerUnit,
            unit: unit,
            discount: null,

            // â­ å­˜é…’ç›¸é—œ
            isStored: forceStore,
            storeMonths: Number(p["å­˜é…’æœŸé™(æœˆ)"]) || 0,
            storeDate: forceStore ? now.toLocaleDateString("zh-TW") : null,
            expireDate: forceStore ? expireDate : null
        });
    }

    renderCart();
}

/*********************************
 * ===== åˆå§‹åŒ–ä»˜æ¬¾æ–¹å¼ =====
 *********************************/
function initPOSButtons() {
    const buttons = document.querySelectorAll("#paymentButtons .payBtn");
    buttons.forEach(btn => {
        btn.addEventListener("click", function () {

            // å–æ¶ˆæ‰€æœ‰ active
            buttons.forEach(b => b.classList.remove("active"));

            // è¨­å®š active
            this.classList.add("active");

            // å¯«å…¥éš±è—æ¬„ä½
            const pay = this.getAttribute("data-pay");
            document.getElementById("posPayment").value = pay;

            const cashPanel = document.getElementById("cashPanel");
            const cashInput = document.getElementById("cashInput");
            const changeOut = document.getElementById("changeOut");

            if (pay === "ç¾é‡‘") {
                cashPanel.style.display = "block";
            } else {
                cashPanel.style.display = "none";
                cashInput.value = "";
                changeOut.innerText = "0";
            }

            renderCart(); // æ›´æ–°ç¸½é¡/æ‰¾é›¶
        });
    });
}

document.addEventListener("DOMContentLoaded", initPOSButtons);

/*********************************
 * ===== æ¸²æŸ“è³¼ç‰©è»Šï¼ˆåŸé‚è¼¯ä¿ç•™ï¼‰=====
 *********************************/
function renderCart() {
    const box = document.getElementById("posCart");
    box.innerHTML = "";
    let totalBeforeTax = 0;

    posCart.forEach((item, i) => {
        let sub = item.quantity * item.price;

        if (item.discount) {
            switch (item.discount.type) {
                case "ç¬¬äºŒä»¶æ¸›10":
                    sub -= Math.floor(item.quantity / 2) * 10;
                    break;
                case "è²·äºŒé€ä¸€":
                    sub -= Math.floor(item.quantity / 3) * item.price;
                    break;
                case "è²·ä¸€é€ä¸€":
                    sub -= Math.floor(item.quantity / 2) * item.price;
                    break;
                case "ç¬¬äºŒä»¶6æŠ˜":
                    sub -= Math.floor(item.quantity / 2) * item.price * 0.4;
                    break;
                default:
                    sub *= item.discount.rate || 1;
                    break;
            }
        }

        totalBeforeTax += sub;

        const row = document.createElement("div");
        row.className = "cartRow";
        row.innerHTML = `
            <span class="name" onclick="openPromoModal(posCart[${i}])">
              ${item.name}
              ${item.isStored ? "<b style='color:#27ae60;'>ğŸ§Šå­˜é…’</b>" : ""}
            </span>
            <span class="qty" onclick="openEditModal(${i},'quantity')">
              ${item.quantity.toFixed(0)} ${item.unit}
            </span>
            <span class="price" onclick="openEditModal(${i},'price')">${item.price}</span>
            <span class="subtotal">${formatNumber(Math.round(sub))}</span>
            <span class="remove">
              <button onclick="removeItem(${i})">åˆª</button>
            </span>
        `;
        box.appendChild(row);
    });

    // ===== è¨ˆç®—ç¨…é¡ =====
    let beforeTax = Math.round(totalBeforeTax);
    let tax = currentTax === "æ‡‰ç¨…" ? Math.round(beforeTax * 0.05) : 0;
    let afterTax = beforeTax + tax;

    // ===== è¨ˆç®—æŠ˜æ‰£/ä½æ¶ˆ =====
const result = calculateFinalAmount(afterTax);
let receivable = result.finalAmount;
    // ===== æ›´æ–° UI =====
    document.getElementById("beforeTax").innerText = formatNumber(beforeTax);
    document.getElementById("taxAmount").innerText = formatNumber(tax);
    document.getElementById("afterTax").innerText = formatNumber(afterTax);

    const posTotalEl = document.getElementById("posTotal");
    posTotalEl.dataset.value = receivable;
    posTotalEl.innerText = formatNumber(receivable);

    updateChange(); // æ›´æ–°æ‰¾é›¶ï¼ˆç¾é‡‘å ´æ™¯ï¼‰

    // ===== ä½æ¶ˆé¡¯ç¤º =====
    const alertEl = document.getElementById("minConsumeAlert");
    const checkoutBtn = document.getElementById("posCheckout");
    if (actualAmount < minConsume && minConsume > 0) {
        if (alertEl) alertEl.style.display = "block";
        posTotalEl.style.color = "#c0392b";
        checkoutBtn.classList.add("minAlert");
    } else {
        if (alertEl) alertEl.style.display = "none";
        posTotalEl.style.color = "#2c3e50";
        checkoutBtn.classList.remove("minAlert");
    }
}

function updateChange() {
    const paymentMethod = document.getElementById("posPayment").value;
    const cash = Number(document.getElementById("cashInput").value) || 0;

    const totalEl = document.getElementById("posTotal");
    const receivable = Number(totalEl.dataset.value || totalEl.innerText.replace(/,/g, "")) || 0;

    const change = paymentMethod === "ç¾é‡‘"
        ? Math.max(cash - receivable, 0)
        : 0;

    document.getElementById("changeOut").innerText = formatNumber(change);
}

// å–å¾—æŸ¥è©¢å­˜é…’æŒ‰éˆ•
  const checkWineBtn = document.getElementById('checkWineBtn');

  // é»æ“Šäº‹ä»¶ï¼šé–‹å•Ÿæ–°è¦–çª—
  checkWineBtn.addEventListener('click', () => {
    window.open('https://excdl.github.io/wine/', '_blank');
  });

// ===== åƒåˆ†ä½æ ¼å¼åŒ– =====
function formatNumber(num) {
    return num.toLocaleString("zh-TW");
}

// ===== ç›£è½æŠ˜æ‰£èˆ‡ç¾é‡‘è¼¸å…¥è®Šå‹•ï¼Œç«‹å³æ›´æ–°æ‰¾é›¶ =====
document.getElementById("discount").addEventListener("input", renderCart);
document.getElementById("cashInput").addEventListener("input", updateChange);


async function updateTodaySales() {
  const now = new Date();
  const formatDate = now.getFullYear() + "/" +
                     String(now.getMonth() + 1).padStart(2, "0") + "/" +
                     String(now.getDate()).padStart(2, "0");

  try {
    const res = await fetch(`${API_URL}?action=todaySales&storeCode=${POS_STORE}&date=${formatDate}`);
    const data = await res.json();

    if(data.status === "success") {
    document.getElementById("todaySalesDisplay").innerHTML =
    `<b>ä»Šæ—¥ç‡Ÿæ¥­æ¦‚æ³</b>
â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
ç¸½é¡ï¼š${data.total.toFixed(0)} å…ƒ
ç¾é‡‘ï¼š${data.cash.toFixed(0)} å…ƒ
åˆ·å¡ï¼š${data.credit.toFixed(0)} å…ƒ
Line Payï¼š${data.linePay.toFixed(0)} å…ƒ`;

    } else {
      console.error("å–å¾—ä»Šæ—¥ç‡Ÿæ¥­é¡å¤±æ•—ï¼š", data.message);
    }
  } catch (err) {
    console.error("æ›´æ–°ä»Šæ—¥ç‡Ÿæ¥­é¡æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
  }
}

// æ¯ 10 ç§’è‡ªå‹•åˆ·æ–°ä¸€æ¬¡
setInterval(updateTodaySales, 30000);

// é é¢è¼‰å…¥ç«‹å³æ›´æ–°ä¸€æ¬¡
updateTodaySales();

// äº¤ç­æŒ‰éˆ•
document.getElementById("shiftEndBtn").onclick = async function() {
  if (posCart.length > 0 && !confirm("è³¼ç‰©è»Šå°šæœ‰æœªçµå¸³å•†å“ï¼Œæ˜¯å¦ä»äº¤ç­ï¼Ÿ")) return;

  const now = new Date();
  const formatDate = now.getFullYear() + "/" +
                     String(now.getMonth() + 1).padStart(2, "0") + "/" +
                     String(now.getDate()).padStart(2, "0");
  const formatTime = String(now.getHours()).padStart(2, "0") + ":" +
                     String(now.getMinutes()).padStart(2, "0") + ":" +
                     String(now.getSeconds()).padStart(2, "0");

  const payload = {
    storeCode: POS_STORE,
    storeName: document.getElementById("storeInfo").innerText.split("ï¼ˆ")[0],
    shiftDate: formatDate,
    shiftEndTime: formatTime
  };

  const res = await fetch(`${API_URL}?action=shiftEnd`, {
    method: "POST",
    body: JSON.stringify(payload)
  });

  const data = await res.json();

  alert(`äº¤ç­æˆåŠŸï¼
æœ¬ç­ç¸½ç‡Ÿæ¥­é¡ï¼š${data.total} å…ƒ
ç¾é‡‘ï¼š${data.cash} å…ƒ
åˆ·å¡ï¼š${data.credit} å…ƒ
Line Payï¼š${data.linePay} å…ƒ`);

  posCart = [];
  renderCart();
  updateTodaySales(); // äº¤ç­å¾Œç«‹å³æ›´æ–°ä»Šæ—¥ç‡Ÿæ¥­é¡
};

// é»æ“ŠæŒ‰éˆ•ä¹Ÿæ›´æ–°
document.getElementById("dailySalesBtn").onclick = updateTodaySales;

// åˆå§‹è¼‰å…¥é é¢æ™‚ä¹Ÿæ›´æ–°
updateTodaySales();


// ===== åˆªé™¤å•†å“ =====
function removeItem(i) { posCart.splice(i, 1); renderCart(); }

// ===== ç·¨è¼¯æ•¸é‡/æŠ˜æ‰£/æ”¶ç¾ =====
document.getElementById("discount").onclick = () => {
  openPOSKeypad("discount", document.getElementById("discount").value);
};

document.getElementById("cashInput").onclick = () => {
  openPOSKeypad("cash", document.getElementById("cashInput").value);
};

/* ===========================================================
   ã€æ‰“é–‹ å°éµç›¤ / å¤§éµç›¤ ç·¨è¼¯ Modalã€‘
=========================================================== */
function openEditModal(index, field) {
    editIndex = index;
    editingField = field;
    modalType = "edit";

    const modal = document.getElementById("editModal");
    const promoDiv = document.getElementById("promoButtons");
    const numpad = document.getElementById("numpad");
    const modalActions = document.querySelector("#editModal .modalActions");
    const modalInput = document.getElementById("modalInput");

    // å…±ç”¨åˆå§‹åŒ–
    promoDiv.style.display = 'none';
    document.getElementById("editCloseBtn").style.display = 'none';

    // ====== å¤§éµç›¤æ¨¡å¼ï¼ˆæŠ˜æ‰£ or æ”¶ç¾é‡‘ï¼‰======
    if (field === 'discount' || field === 'cash') {
        kpTarget = field;
        document.getElementById("posKeypadTitle").innerText =
            field === "discount" ? "è¼¸å…¥æŠ˜æ‰£" : "æ”¶ç¾é‡‘";

        document.getElementById("posKeypadInput").value =
            field === "discount"
                ? document.getElementById("discount").value
                : document.getElementById("cashInput").value || "";

        document.getElementById("posKeypadModal").style.display = "flex";
        return;
    }

    // ====== å°éµç›¤æ¨¡å¼ ======
    numpad.style.display = 'grid';
    modalInput.style.display = 'block';
    modalInput.readOnly = false;
    modalActions.style.display = 'flex';

    modalInput.value = posCart[index]?.[field] ?? "";
    document.getElementById("modalProductName").innerText = "è¼¸å…¥";
    document.getElementById("modalProductName").style.color = "#fff";
    modal.style.display = "flex";
}

/* ===========================================================
   ã€å„ªæƒ æ–¹æ¡ˆ Modalã€‘
=========================================================== */
function openPromoModal(item) {
    modalType = 'promo';
    editIndex = null;

    const modal = document.getElementById("editModal");
    const promoDiv = document.getElementById("promoButtons");

    document.getElementById("numpad").style.display = 'none';
    document.getElementById("modalInput").style.display = 'none';
    promoDiv.style.display = 'grid';
    promoDiv.innerHTML = '';
    document.querySelector("#editModal .modalActions").style.display = 'none';
    document.getElementById("editCloseBtn").style.display = 'block';

    const promoList = [
        { name: '95æŠ˜', rate: 0.95 },
        { name: '9æŠ˜', rate: 0.9 },
        { name: '85æŠ˜', rate: 0.85 },
        { name: '8æŠ˜', rate: 0.8 },
        { name: '7æŠ˜', rate: 0.7 },
        { name: '6æŠ˜', rate: 0.6 },
        { name: 'è²·ä¸€é€ä¸€', type: 'è²·ä¸€é€ä¸€' },
        { name: 'è²·äºŒé€ä¸€', type: 'è²·äºŒé€ä¸€' },
        { name: 'ç¬¬äºŒä»¶æ¸›10', type: 'ç¬¬äºŒä»¶æ¸›10' },
        { name: 'ç¬¬äºŒä»¶6æŠ˜', type: 'ç¬¬äºŒä»¶6æŠ˜' }
    ];

    promoList.forEach(p => {
        const btn = document.createElement("button");
        btn.innerText = p.name;
        btn.onclick = () => {
            let idx = posCart.findIndex(x => x.name === item.name);
            if (idx === -1) addPOSItem(item);

            idx = posCart.findIndex(x => x.name === item.name);
            if (idx !== -1) {
                posCart[idx].discount = p.type
                    ? { type: p.type }
                    : { rate: p.rate, type: "æŠ˜æ‰£" };
            }

            closeModal();
            renderCart();
        };
        promoDiv.appendChild(btn);
    });

    document.getElementById("modalProductName").innerText = item.name;
    modal.style.display = "flex";
}

/* ===========================================================
   ã€å°éµç›¤æ“ä½œã€‘
=========================================================== */
function np(v) {
    const input = document.getElementById("modalInput");
    input.value += v;
}

function backspace() {
    const input = document.getElementById("modalInput");
    input.value = input.value.slice(0, -1);
}

function confirmEdit() {
    const val = document.getElementById("modalInput").value;

    if (editIndex !== null && editingField === 'quantity' && posCart[editIndex].unit === 'æ–¤') {
        const [j = 0, l = 0, q = 0] = val.split('.').map(Number);
        posCart[editIndex].quantity = j + l / 16 + q / 160;
    } else if (editIndex !== null) {
        posCart[editIndex][editingField] = Number(val);
    }

    closeModal();
    renderCart();
}

/* ===========================================================
   ã€é—œé–‰ Modalï¼ˆçµ±ä¸€ï¼‰ã€‘
=========================================================== */
function closeModal() {
    document.getElementById("editModal").style.display = 'none';
    document.getElementById("posKeypadModal").style.display = 'none';

    // æ¢å¾©é è¨­ UI
    document.querySelector("#editModal .modalActions").style.display = 'flex';
    document.getElementById("modalInput").style.display = 'block';
    document.getElementById("modalInput").readOnly = false;
    document.getElementById("numpad").style.display = 'grid';
    document.getElementById("promoButtons").style.display = 'none';
    document.getElementById("editCloseBtn").style.display = 'none';
}

/* ===========================================================
   ã€POS å¤§éµç›¤è¼¸å…¥ / åˆªé™¤ / ç¢ºèªï¼ˆçµ±ä¸€ç‰ˆæœ¬ï¼‰ã€‘
=========================================================== */
function openPOSKeypad(type, value = "0") {
    kpTarget = type;
    document.getElementById("posKeypadTitle").innerText =
        type === "discount" ? "æŠ˜æ‰£é‡‘é¡" : "æ”¶ç¾é‡‘";

    document.getElementById("posKeypadInput").value = value;
    document.getElementById("posKeypadModal").style.display = "flex";
}

function kpInput(v) {
    const input = document.getElementById("posKeypadInput");
    if (input.value === "0") input.value = "";
    input.value += v;
}

function kpBack() {
    const input = document.getElementById("posKeypadInput");
    input.value = input.value.slice(0, -1);
    if (!input.value) input.value = "0";
}

function kpConfirm() {
    const v = document.getElementById("posKeypadInput").value;

    if (kpTarget === "discount") {
        document.getElementById("discount").value = v;
        renderCart();
    }

    if (kpTarget === "cash") {
        document.getElementById("cashInput").value = v;
        updateChange();
    }

    document.getElementById("posKeypadModal").style.display = "none";
}
let allowMinConsumeCheckout = false;
function getMinConsumeTotal() {
  const people = Number(document.getElementById("peopleCount")?.value) || 0;
  const perMin = Number(document.getElementById("minConsumeInput")?.value) || 0;
  return people * perMin;
}

// ä½æ¶ˆè®Šå‹•æ™‚ï¼Œç«‹å³é‡ç®—
document.getElementById("minConsumeInput").addEventListener("input", () => {
  renderCart();
});
function calculateFinalAmount(afterTaxAmount) {

    const discountValue = Number(document.getElementById("discount").value) || 0;
    const actual = afterTaxAmount - discountValue;

    const people = Number(document.getElementById("peopleCount")?.value) || 0;
    const perMin = Number(document.getElementById("minConsumeInput")?.value) || 0;
    const minTotal = people * perMin;

    let finalAmount = 0;
    let needConfirm = false;

    // ===== æ–°è¦å‰‡ =====
    if (perMin <= 300 && perMin > 0) {

        // ä½æ¶ˆ â‰¤ 300 â†’ ä½æ¶ˆ + æ¶ˆè²»
        finalAmount = actual + minTotal;

    } else {

        // > 300 æ‰éœ€è¦æ¯”è¼ƒ
        if (actual < minTotal) {
            finalAmount = minTotal;
            needConfirm = true;   // æ˜¯å¦è¦è·³æç¤º
        } else {
            finalAmount = actual;
        }
    }

    return {
        actual,
        minTotal,
        finalAmount,
        needConfirm
    };
}

function showMinConsumeConfirm(actual,min){
  document.getElementById("minConsumeConfirmText").innerHTML =
    `å¯¦éš›æ¶ˆè²» ${formatNumber(actual)} å…ƒ<br>
     ä½æ¶ˆ ${formatNumber(min)} å…ƒ<br>
     éœ€è£œå·® <b style="color:#c0392b">${formatNumber(min-actual)}</b> å…ƒ`;
  document.getElementById("minConsumeConfirm").style.display="flex";
}
function cancelMinConsumeCheckout(){
  allowMinConsumeCheckout=false;
  document.getElementById("minConsumeConfirm").style.display="none";
}
function confirmMinConsumeCheckout(){
  allowMinConsumeCheckout=true;
  document.getElementById("minConsumeConfirm").style.display="none";
  document.getElementById("posCheckout").click();
}

  
function setTax(t) {
    currentTax = t;
    document.getElementById("taxIncluded").classList.toggle('active', t === "æ‡‰ç¨…");
    document.getElementById("taxExempt").classList.toggle('active', t === "å…ç¨…");
    renderCart();
}

  // é é¢è¼‰å…¥æ™‚é è¨­å…ç¨…
window.addEventListener("DOMContentLoaded", () => {
    setTax("å…ç¨…");

    document.getElementById("peopleCount")
      ?.addEventListener("input", renderCart);

    document.getElementById("minConsumeInput")
      ?.addEventListener("input", renderCart);
});;


function formatDiscountRate(rate) {
    let d = rate * 100;          // 0.9 â†’ 90
    let s = d.toString();        // "90"

    // 90 â†’ 9, 80 â†’ 8, 70 â†’ 7...
    if (d % 10 === 0) {
        s = (d / 10).toString();
    }
    return s + "æŠ˜";
}
  
  
function calcDiscountedSubtotal(item) {
    let sub = item.quantity * item.price;
    if (item.discount) {
        switch (item.discount.type) {
            case "ç¬¬äºŒä»¶æ¸›10":
                sub -= Math.floor(item.quantity / 2) * 10;
                break;
            case "è²·äºŒé€ä¸€":
                sub -= Math.floor(item.quantity / 3) * item.price;
                break;
            case "è²·ä¸€é€ä¸€":
                sub -= Math.floor(item.quantity / 2) * item.price;
                break;
            case "ç¬¬äºŒä»¶6æŠ˜":
                sub -= Math.floor(item.quantity / 2) * item.price * 0.4;
                break;
            case "æŠ˜æ‰£":      // ä¾‹å¦‚ 95æŠ˜ã€9æŠ˜
                sub *= item.discount.rate;
                break;
        }
    }
    return Math.round(sub);
}

 async function sendCheckoutToSheet() {
    const now = new Date();

    // ===== payload åŸºæœ¬è³‡æ–™ =====
    const payload = {
        orderDate: now.toLocaleDateString("zh-TW"),
        orderTime: now.toLocaleTimeString("zh-TW", { hour12: false }),
        checkoutDateTime: now.toLocaleString("zh-TW", { hour12: false }),

        storeName: document.getElementById("storeInfo").innerText.split("ï¼ˆ")[0],
        storeCode: POS_STORE,

        salesName: document.getElementById("salesInput")?.value || "",
        peopleCount: Number(document.getElementById("peopleCount")?.value) || 0,

        taxStatus: currentTax,
        totalAmount: parseNumber(document.getElementById("posTotal").innerText),
        taxAmount: parseNumber(document.getElementById("taxAmount").innerText),
        paymentMethod: document.getElementById("posPayment").value,
        discount: Number(document.getElementById("discount").value) || 0,
        cashReceive: Number(document.getElementById("cashInput").value) || 0,
        change: Number(document.getElementById("changeOut").innerText) || 0,

        // è³¼ç‰©è»Šå•†å“
        items: posCart.map(it => {
            const discountedSubtotal = calcDiscountedSubtotal(it);

            let promoText = "";
            if (it.discount) {
                promoText = it.discount.type === "æŠ˜æ‰£"
                    ? formatDiscountRate(it.discount.rate)
                    : it.discount.type;
            }

            return {
                category: products.find(p => p["å•†å“åç¨±"] === it.name)?.["é¡åˆ¥"] || "",
                name: it.name,
                quantity: it.quantity,
                price: it.price,
                subtotal: discountedSubtotal,
                promo: promoText
            };
        })
    };

    // ===== è‡ªå‹•ç”¢ç”Ÿå­˜é…’è³‡æ–™ =====
      function addMonths(date, months) {
        const d = new Date(date);
        d.setMonth(d.getMonth() + months);
        return d.toLocaleDateString("zh-TW");
    }

    const storedItems = posCart
        .filter(it => it.isStored)
        .map(it => {
            const product = products.find(p => p["å•†å“åç¨±"] === it.name);
            const nowDate = new Date();
            return {
                customerName: document.getElementById("customerName").value,
                customerPhone: document.getElementById("customerPhone").value,
                storeCode: payload.storeCode,
                storeName: payload.storeName,
                productName: it.name,
                totalQty: it.quantity,
                remainQty: it.quantity,
                unit: it.unit,
                storeDate: nowDate.toLocaleDateString("zh-TW"),
                expireDate: product && product["å­˜é…’æœŸé™(æœˆ)"] 
                    ? addMonths(nowDate, Number(product["å­˜é…’æœŸé™(æœˆ)"]))
                    : addMonths(nowDate, 2)
            };
        });

    payload.storedItems = storedItems;

    // ===== é€å‡ºè‡³ GAS =====
    await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
    });
}


// ===== å°è¡¨æ©Ÿç‹€æ…‹æª¢æŸ¥ï¼ˆä¸å½±éŸ¿çµå¸³ï¼‰=====
async function printerIsReady() {
    try {
        const printers = await qz.printers.find();
        return (printers && printers.length > 0);
    } catch (e) {
        return false;
    }
}

// ===== ä½æ¶ˆèˆ‡æ‡‰æ”¶ç¸½é¡å³æ™‚æ›´æ–° =====
function updateFinalAmountAndAlert() {
    const afterTax = parseNumber(document.getElementById("afterTax").innerText);
    const discountVal = Number(document.getElementById("discount")?.value) || 0;
    const actual = afterTax - discountVal;

    const people = Number(document.getElementById("peopleCount")?.value) || 0;
    const perMin = Number(document.getElementById("minConsumeInput")?.value) || 0;
    const minTotal = people * perMin;

    let finalAmount = 0;
    let alertMsg = "";

    if (perMin > 0 && perMin <= 300) {
        finalAmount = actual + minTotal;
    } else {
        finalAmount = Math.max(actual, minTotal);
        if (actual < minTotal) {
            alertMsg = `âš ï¸ æ¶ˆè²»é‡‘é¡ ${actual} å…ƒä½æ–¼æœ€ä½æ¶ˆè²» ${minTotal} å…ƒ`;
        }
    }

    document.getElementById("posTotal").innerText = finalAmount;
    document.getElementById("posTotal").dataset.value = finalAmount;

    // é¡¯ç¤ºæç¤ºè¨Šæ¯
    const minConsumeAlert = document.getElementById("minConsumeAlert");
    if (minConsumeAlert) {
        minConsumeAlert.innerText = alertMsg;
        minConsumeAlert.style.display = alertMsg ? "block" : "none";
    }
}

// ç›£è½äººæ•¸ã€ä½æ¶ˆã€æŠ˜æ‰£èˆ‡å¯¦æ”¶è®Šå‹•
["peopleCount", "minConsumeInput", "afterTax", "discount"].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("input", updateFinalAmountAndAlert);
});
updateFinalAmountAndAlert(); // åˆå§‹åŒ–


document.getElementById("posCheckout").onclick = async function () {
    const checkoutBtn = document.getElementById("posCheckout");
    if (checkoutBtn.disabled) return;
    const originalText = checkoutBtn.innerText;
    checkoutBtn.disabled = true;
    checkoutBtn.innerText = "çµå¸³ä¸­...";

    try {
        const paymentMethod = document.getElementById("posPayment")?.value;
        if (!paymentMethod) {
            alert("è«‹å…ˆé¸æ“‡ä»˜æ¬¾æ–¹å¼ï¼");
            checkoutBtn.innerText = originalText;
            checkoutBtn.disabled = false;
            return;
        }

        const afterTax = parseNumber(document.getElementById("afterTax").innerText);
        const discountVal = Number(document.getElementById("discount")?.value) || 0;
        const actual = afterTax - discountVal;

        const people = Number(document.getElementById("peopleCount")?.value) || 0;
        const perMin = Number(document.getElementById("minConsumeInput")?.value) || 0;
        const minTotal = people * perMin;

        // è¨ˆç®—çµå¸³ç¸½é¡
        let finalAmount;
        if (perMin > 0 && perMin <= 300) {
            finalAmount = actual + minTotal;
        } else {
            finalAmount = Math.max(actual, minTotal);
        }

        // ğŸš¨ ç¸½é¡ç‚º0é˜»æ­¢çµå¸³
        if (finalAmount <= 0) {
            alert("âŒ çµå¸³ç¸½é¡ç‚º 0ï¼Œç„¡æ³•çµå¸³ï¼");
            checkoutBtn.innerText = originalText;
            checkoutBtn.disabled = false;
            return;
        }

        // æœ€ä½æ¶ˆè²»ç¢ºèªï¼ˆåªåœ¨ perMin > 300ï¼‰
        if (perMin > 300 && actual < minTotal && !allowMinConsumeCheckout) {
            const message = `æ‚¨çš„æ¶ˆè²»é‡‘é¡ç‚º ${actual} å…ƒï¼Œä½æ–¼æœ€ä½æ¶ˆè²»é¡ ${minTotal} å…ƒï¼Œæ˜¯å¦ç¢ºèªçµå¸³ï¼Ÿ`;
            if (!confirm(message)) {
                checkoutBtn.innerText = originalText;
                checkoutBtn.disabled = false;
                return;
            }
            allowMinConsumeCheckout = true;
            document.getElementById("afterTax").innerText = minTotal;
            updateFinalAmountAndAlert();
        } else {
            allowMinConsumeCheckout = false;
        }

        // è³¼ç‰©è»Šç‚º 0 æ™‚åˆ¤æ–·ï¼ˆåƒ…åœ¨ä½æ¶ˆ > 300 æ‰é˜»æ­¢ï¼‰
        if (posCart.length === 0 && perMin > 300) {
            alert("âŒ è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œç„¡æ³•çµå¸³ï¼");
            checkoutBtn.innerText = originalText;
            checkoutBtn.disabled = false;
            return;
        }

        // âœ… ä¸€åˆ‡æª¢æŸ¥é€šéï¼Œé–‹å§‹çµå¸³æµç¨‹
        await startCheckoutFlow(checkoutBtn, originalText);

    } catch (err) {
        console.error("çµå¸³éç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
        // åªæœ‰çœŸæ­£éŒ¯èª¤æ‰ alert
        alert("çµå¸³å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
        checkoutBtn.innerText = originalText;
        checkoutBtn.disabled = false;
    }
};


// ===== çµå¸³æµç¨‹ =====
async function startCheckoutFlow(checkoutBtn, originalText) {
    try {
        // Step 1ï¼šçµå¸³å¯«å…¥è©¦ç®—è¡¨
        await sendCheckoutToSheet();
        setTimeout(updateTodaySales, 0);

        // ===== å°ç¥¨åˆ—å°è¨­å®š =====
        const PRINTER_PROFILE = {
            "58": { charsPerLine: 32, nameWidth: 14, qtyWidth: 6, priceWidth: 6, subWidth: 6 },
            "80": { charsPerLine: 42, nameWidth: 20, qtyWidth: 6, priceWidth: 8, subWidth: 8 }
        };

        const receiptPayload = {
            storeName: "ç”Ÿé®® POS",
            datetime: new Date().toLocaleString(),
            payment: document.getElementById("posPayment")?.value,
            openCashDrawer: true,
            items: posCart.map(item => {
                let subtotal = item.quantity * item.price;
                let discountText = "";
                let discountAmount = 0;
                if (item.discount) {
                    switch (item.discount.type) {
                        case "ç¬¬äºŒä»¶æ¸›10":
                            discountAmount = Math.floor(item.quantity / 2) * 10;
                            subtotal -= discountAmount;
                            discountText = "ç¬¬äºŒä»¶æ¸›10";
                            break;
                        case "è²·äºŒé€ä¸€":
                            discountAmount = Math.floor(item.quantity / 3) * item.price;
                            subtotal -= discountAmount;
                            discountText = "è²·äºŒé€ä¸€";
                            break;
                        case "è²·ä¸€é€ä¸€":
                            discountAmount = Math.floor(item.quantity / 2) * item.price;
                            subtotal -= discountAmount;
                            discountText = "è²·ä¸€é€ä¸€";
                            break;
                        case "ç¬¬äºŒä»¶6æŠ˜":
                            discountAmount = Math.floor(item.quantity / 2) * item.price * 0.4;
                            subtotal -= discountAmount;
                            discountText = "ç¬¬äºŒä»¶6æŠ˜";
                            break;
                        default:
                            subtotal *= item.discount.rate || 1;
                            discountAmount = item.price * item.quantity * (1 - (item.discount.rate || 1));
                            discountText = `æŠ˜æ‰£${(item.discount.rate || 1) * 100}%`;
                            break;
                    }
                }
                return { name: item.name, qty: item.quantity, price: item.price, subtotal, discountText, discountAmount };
            }),
            summary: {
                discount: document.getElementById("discount")?.value || 0,
                tax: document.getElementById("taxAmount")?.innerText || 0,
                total: document.getElementById("posTotal")?.innerText || 0
            }
        };

        // ===== åˆ—å°æµç¨‹ =====
        if (window.qz) {
            setTimeout(async () => {
                try {
                    const printers = await qz.printers.find();
                    await Promise.all(
                        printers.map(async (printerName) => {
                            const selectedSize = /80/.test(printerName) ? "80" : "58";
                            const profile = PRINTER_PROFILE[selectedSize];
                            const receiptText = buildReceiptText(receiptPayload, profile);

                            const esc = [
                                '\x1B\x40',
                                '\x1B\x61\x01',
                                "ç”Ÿé®® POS å°ç¥¨\n",
                                '\x1B\x61\x00',
                                receiptText + "\n",
                                '\x1B\x64\x02',
                                '\x1B\x70\x00\x3C\xFF',
                                '\x1D\x56\x42\x03'
                            ];

                            const config = qz.configs.create(printerName);
                            await qz.print(config, [{ type: 'raw', format: 'command', data: esc.join('') }]);
                            console.log(`âœ… åˆ—å°å®Œæˆï¼š${printerName}`);
                        })
                    );
                } catch (err) {
                    console.error("åˆ—å°å¤±æ•—", err);
                    alert("âš ï¸ çµå¸³æˆåŠŸï¼Œä½†åˆ—å°å¤±æ•—ï¼Œè«‹æª¢æŸ¥å°è¡¨æ©Ÿ");
                }
            }, 0);
        } else if (window.webkit?.messageHandlers?.posPrint) {
            window.webkit.messageHandlers.posPrint.postMessage(receiptPayload);
        }

        // â­ çµå¸³å®Œæˆæç¤º
        alert("âœ… çµå¸³å®Œæˆï¼Œå·²é€å‡ºåˆ—å°");

        // ===== çµå¸³å¾Œæ¸…ç©ºæ¬„ä½ =====
        posCart = [];
        if (document.getElementById("discount")) document.getElementById("discount").value = "";
        if (document.getElementById("cashInput")) document.getElementById("cashInput").value = "";
        if (document.getElementById("changeOut")) document.getElementById("changeOut").innerText = "0";
        document.getElementById("peopleCount").value = "0";
        if (document.getElementById("customerName")) document.getElementById("customerName").value = "";
        if (document.getElementById("customerPhone")) document.getElementById("customerPhone").value = "";

        fetchSalesList();
        if (typeof renderCart === "function") renderCart();
        document.querySelector('#paymentButtons .payBtn[data-pay="ç¾é‡‘"]')?.click();

        checkoutBtn.innerText = originalText;
        checkoutBtn.disabled = false;

    } catch (error) {
        console.error("çµå¸³éç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤ï¼š", error);
        alert("çµå¸³å¤±æ•—ï¼Œè«‹é‡è©¦ã€‚");
        checkoutBtn.innerText = originalText;
        checkoutBtn.disabled = false;
    }
}
  

</script>

</body>
</html>
